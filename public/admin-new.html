<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìŠˆ ê´€ë¦¬ - EventBET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">
            <i class="fas fa-edit mr-2"></i>
            ì´ìŠˆ ê´€ë¦¬
        </h1>
        
        <!-- ì¼ê´„ ë“±ë¡ ë²„íŠ¼ -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">ë¹ ë¥¸ ì‘ì—…</h2>
            <button onclick="showBatchUpload()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 text-lg font-bold">
                <i class="fas fa-upload mr-2"></i>
                ì¼ê´„ ë“±ë¡ (CSV/ì—‘ì…€)
            </button>
        </div>
        
        <!-- ì´ìŠˆ ë“±ë¡ í¼ -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">ìƒˆ ì´ìŠˆ ë“±ë¡</h2>
            <form id="issueForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">í•œêµ­ì–´ ì œëª©</label>
                        <input type="text" id="title_ko" class="w-full px-4 py-2 border rounded" placeholder="ë¹„íŠ¸ì½”ì¸ 10ë§Œë¶ˆ ëŒíŒŒ?" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">English Title</label>
                        <input type="text" id="title_en" class="w-full px-4 py-2 border rounded" placeholder="Will Bitcoin hit $100k?" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ä¸­æ–‡æ ‡é¢˜</label>
                        <input type="text" id="title_zh" class="w-full px-4 py-2 border rounded" placeholder="æ¯”ç‰¹å¸çªç ´10ä¸‡ç¾å…ƒ?" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="title_ja" class="w-full px-4 py-2 border rounded" placeholder="ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ãŒ10ä¸‡ãƒ‰ãƒ«çªç ´?" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">ì¹´í…Œê³ ë¦¬</label>
                        <select id="category" class="w-full px-4 py-2 border rounded" required>
                            <option value="crypto">ì•”í˜¸í™”í</option>
                            <option value="politics">ì •ì¹˜</option>
                            <option value="sports">ìŠ¤í¬ì¸ </option>
                            <option value="entertainment">ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
                            <option value="economy">ê²½ì œ</option>
                            <option value="science">ê³¼í•™/ê¸°ìˆ </option>
                            <option value="climate">ê¸°í›„/í™˜ê²½</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ì´ˆê¸° USDT</label>
                        <input type="number" id="initial_usdt" class="w-full px-4 py-2 border rounded" value="60" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ë§Œë£Œì¼ (ì¼)</label>
                        <input type="number" id="expire_days" class="w-full px-4 py-2 border rounded" value="7" min="1" required>
                    </div>
                </div>
                
                <input type="hidden" id="edit_id" value="">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    <i class="fas fa-save mr-2"></i>
                    <span id="submitText">ë“±ë¡</span>
                </button>
                <button type="button" onclick="cancelEdit()" id="cancelBtn" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 hidden">
                    ì·¨ì†Œ
                </button>
            </form>
        </div>
        
        <!-- ì´ìŠˆ ëª©ë¡ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">ë“±ë¡ëœ ì´ìŠˆ</h2>
            <div id="issuesList"></div>
        </div>
    </div>

    <script>
        // API ê¸°ë°˜ ì´ìŠˆ ê´€ë¦¬
        const API_BASE = '/api/issues'
        let allIssues = []
        
        // Load issues from API
        async function loadIssues() {
            try {
                const response = await fetch(API_BASE)
                const data = await response.json()
                
                allIssues = data.success && data.issues ? data.issues : []
                renderIssues()
            } catch (error) {
                console.error('ì´ìŠˆ ë¡œë”© ì‹¤íŒ¨:', error)
                alert('ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                allIssues = []
                renderIssues()
            }
        }
        
        // Render issues
        function renderIssues() {
            const list = document.getElementById('issuesList')
            
            if (allIssues.length === 0) {
                list.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                return
            }
            
            list.innerHTML = allIssues.map((issue) => {
                const expireDate = issue.expire_date ? new Date(issue.expire_date) : null
                const createdAt = issue.createdAt || issue.created_at
                const initialUsdt = issue.initial_usdt || 60
                const yesBet = issue.yes_bet || 0
                const noBet = issue.no_bet || 0
                
                return `
                <div class="border rounded p-4 mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">${issue.title_ko || 'N/A'}</h3>
                            <p class="text-sm text-gray-600">${issue.title_en || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${issue.title_zh || 'N/A'}</p>
                            <p class="text-sm text-gray-600">${issue.title_ja || 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="deleteIssue('${issue.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-2">
                        <div><span class="inline-block bg-blue-100 px-2 py-1 rounded">${issue.category || 'N/A'}</span></div>
                        <div>ë§Œë£Œì¼: ${expireDate ? expireDate.toLocaleDateString('ko-KR') : 'N/A'}</div>
                        <div>ì´ˆê¸° USDT: ${initialUsdt}</div>
                        <div>Yes: ${yesBet} / No: ${noBet}</div>
                    </div>
                    <div class="text-xs text-gray-500">
                        ë“±ë¡: ${createdAt ? new Date(createdAt).toLocaleString('ko-KR') : 'N/A'}
                    </div>
                </div>
            `}).join('')
        }
        
        // Submit form
        document.getElementById('issueForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const formData = {
                title_ko: document.getElementById('title_ko').value,
                title_en: document.getElementById('title_en').value,
                title_zh: document.getElementById('title_zh').value,
                title_ja: document.getElementById('title_ja').value,
                category: document.getElementById('category').value,
                initial_usdt: parseFloat(document.getElementById('initial_usdt').value),
                expire_days: parseInt(document.getElementById('expire_days').value)
            }
            
            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                
                const result = await response.json()
                
                if (result.success) {
                    alert('âœ… ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në©”ì¸ í˜ì´ì§€ë¥¼ Ctrl + Shift + Rë¡œ ìƒˆë¡œê³ ì¹¨í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.')
                    document.getElementById('issueForm').reset()
                    await loadIssues()
                } else {
                    alert('âŒ ë“±ë¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'))
                }
            } catch (error) {
                console.error('ë“±ë¡ ì‹¤íŒ¨:', error)
                alert('âŒ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
            }
        })
        
        // Delete issue
        async function deleteIssue(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return
            
            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE'
                })
                
                const result = await response.json()
                
                if (result.success) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!')
                    await loadIssues()
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'))
                }
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error)
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
            }
        }
        
        // Cancel edit
        function cancelEdit() {
            document.getElementById('issueForm').reset()
            document.getElementById('edit_id').value = ''
            document.getElementById('submitText').textContent = 'ë“±ë¡'
            document.getElementById('cancelBtn').classList.add('hidden')
        }
        
        // ì¼ê´„ ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ
        function showBatchUpload() {
            const modal = document.createElement('div')
            modal.id = 'batchModal'
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50'
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-90vh overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">ì¼ê´„ ë“±ë¡</h2>
                        <button onclick="closeBatchModal()" class="text-gray-500 hover:text-gray-800 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">ğŸ“‹ CSV í˜•ì‹ ì•ˆë‚´</h3>
                        <p class="text-sm text-gray-600 mb-3">ì•„ë˜ í˜•ì‹ìœ¼ë¡œ CSV íŒŒì¼ì„ ì‘ì„±í•˜ê±°ë‚˜, í…ìŠ¤íŠ¸ ì˜ì—­ì— ì§ì ‘ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                        <div class="bg-gray-100 p-4 rounded text-xs font-mono overflow-x-auto mb-4">
title_ko,title_en,title_zh,title_ja,category,initial_usdt,expire_days
ë¹„íŠ¸ì½”ì¸ 10ë§Œë¶ˆ ëŒíŒŒ?,Will Bitcoin hit $100k?,æ¯”ç‰¹å¸çªç ´10ä¸‡ç¾å…ƒ?,ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ãŒ10ä¸‡ãƒ‰ãƒ«çªç ´?,crypto,100000,30
íŠ¸ëŸ¼í”„ ì¬ì„ ?,Trump Re-elected?,ç‰¹æœ—æ™®è¿ä»»?,ãƒˆãƒ©ãƒ³ãƒ—å†é¸?,politics,50000,60
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block font-bold mb-2">CSV ë°ì´í„° ì…ë ¥</label>
                        <textarea id="batchCsvInput" class="w-full border rounded p-4 font-mono text-sm h-64" 
                                  placeholder="title_ko,title_en,title_zh,title_ja,category,initial_usdt,expire_days
ë¹„íŠ¸ì½”ì¸ 10ë§Œë¶ˆ ëŒíŒŒ?,Will Bitcoin hit $100k?,æ¯”ç‰¹å¸çªç ´10ä¸‡ç¾å…ƒ?,ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³ãŒ10ä¸‡ãƒ‰ãƒ«çªç ´?,crypto,100000,30"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block font-bold mb-2">ë˜ëŠ” CSV íŒŒì¼ ì—…ë¡œë“œ</label>
                        <input type="file" id="batchCsvFile" accept=".csv,.txt" class="w-full border rounded p-2">
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="processBatchUpload()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 font-bold flex-1">
                            <i class="fas fa-upload mr-2"></i>
                            ì¼ê´„ ë“±ë¡ ì‹œì‘
                        </button>
                        <button onclick="closeBatchModal()" class="bg-gray-500 text-white px-6 py-3 rounded hover:bg-gray-600">
                            ì·¨ì†Œ
                        </button>
                    </div>
                    
                    <div id="batchResult" class="mt-6"></div>
                </div>
            `
            document.body.appendChild(modal)
            
            // íŒŒì¼ ì—…ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì˜ì—­ì— ë¡œë“œ
            document.getElementById('batchCsvFile').addEventListener('change', (e) => {
                const file = e.target.files[0]
                if (file) {
                    const reader = new FileReader()
                    reader.onload = (e) => {
                        document.getElementById('batchCsvInput').value = e.target.result
                    }
                    reader.readAsText(file)
                }
            })
        }
        
        function closeBatchModal() {
            const modal = document.getElementById('batchModal')
            if (modal) modal.remove()
        }
        
        // CSV íŒŒì‹± ë° ì¼ê´„ ë“±ë¡
        async function processBatchUpload() {
            const csvText = document.getElementById('batchCsvInput').value.trim()
            if (!csvText) {
                alert('CSV ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')
                return
            }
            
            const resultDiv = document.getElementById('batchResult')
            resultDiv.innerHTML = '<p class="text-blue-600 font-bold">ì²˜ë¦¬ ì¤‘...</p>'
            
            try {
                // CSV íŒŒì‹±
                const lines = csvText.split('\\n').filter(line => line.trim())
                const headers = lines[0].split(',').map(h => h.trim())
                
                // í—¤ë” ê²€ì¦
                const requiredHeaders = ['title_ko', 'title_en', 'title_zh', 'title_ja', 'category', 'initial_usdt', 'expire_days']
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h))
                if (missingHeaders.length > 0) {
                    resultDiv.innerHTML = '<p class="text-red-600">âŒ ì˜¤ë¥˜: í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ' + missingHeaders.join(', ') + '</p>'
                    return
                }
                
                const issues = []
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim())
                    if (values.length < requiredHeaders.length) continue
                    
                    const issue = {}
                    headers.forEach((header, idx) => {
                        issue[header] = values[idx]
                    })
                    
                    // ë°ì´í„° íƒ€ì… ë³€í™˜
                    issue.initial_usdt = parseFloat(issue.initial_usdt) || 60
                    issue.expire_days = parseInt(issue.expire_days) || 7
                    
                    issues.push(issue)
                }
                
                if (issues.length === 0) {
                    resultDiv.innerHTML = '<p class="text-red-600">âŒ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                    return
                }
                
                // API í˜¸ì¶œ: /api/issues/batch
                const response = await fetch('/api/issues/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ issues })
                })
                
                const result = await response.json()
                
                if (result.success) {
                    resultDiv.innerHTML = \`
                        <div class="bg-green-100 border border-green-500 rounded p-4">
                            <p class="text-green-800 font-bold">âœ… ì„±ê³µ!</p>
                            <p class="text-sm">\${result.count}ê°œì˜ ì´ìŠˆê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            <p class="text-xs text-gray-600 mt-2">ë©”ì¸ í˜ì´ì§€ë¥¼ Ctrl+Shift+Rë¡œ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</p>
                        </div>
                    \`
                    await loadIssues()
                    setTimeout(closeBatchModal, 3000)
                } else {
                    resultDiv.innerHTML = '<p class="text-red-600">âŒ ë“±ë¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</p>'
                }
            } catch (error) {
                console.error('ì¼ê´„ ë“±ë¡ ì˜¤ë¥˜:', error)
                resultDiv.innerHTML = '<p class="text-red-600">âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</p>'
            }
        }
        
        // Load on page load
        loadIssues()
    </script>
</body>
</html>
